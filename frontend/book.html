<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Details</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  body {
    background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 50%, #0c0c0c 100%);
    color: white;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 80%, rgba(30, 144, 255, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(30, 144, 255, 0.05) 0%, transparent 50%);
    animation: pulseBackground 8s ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes pulseBackground {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 0.8; }
  }

  .navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.2rem 3rem;
    background: rgba(20, 20, 20, 0.95);
    backdrop-filter: blur(20px);
    position: sticky;
    top: 0;
    z-index: 1000;
    border-bottom: 1px solid rgba(30, 144, 255, 0.3);
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5);
  }

  .navbar h2 {
    margin: 0;
    font-size: 2.2rem;
    background: linear-gradient(135deg, #1e90ff, #00bfff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
    letter-spacing: 2px;
    text-shadow: 0 2px 10px rgba(30, 144, 255, 0.3);
    position: relative;
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .nav-links button, .nav-links select {
    background: rgba(51, 51, 51, 0.8);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.8rem 1.5rem;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
  }

  .nav-links button:hover, .nav-links select:hover {
    background: rgba(85, 85, 85, 0.9);
    transform: translateY(-2px);
    border-color: rgba(30, 144, 255, 0.5);
    box-shadow: 0 8px 25px rgba(30, 144, 255, 0.2);
  }

  .book-details {
    display: flex;
    gap: 3rem;
    padding: 3rem;
    max-width: 1200px;
    margin: 2rem auto;
    position: relative;
    z-index: 1;
  }

  .book-cover {
    flex: 0 0 300px;
  }

  .book-cover img {
    width: 100%;
    height: 450px;
    object-fit: cover;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  }

  .book-info {
    flex: 1;
  }

  .book-title {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #1e90ff, #00bfff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .book-author {
    font-size: 1.3rem;
    color: #ccc;
    margin-bottom: 2rem;
  }

  .book-meta {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(30, 30, 30, 0.8);
    padding: 1rem;
    border-radius: 12px;
    min-width: 100px;
  }

  .meta-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #1e90ff;
  }

  .meta-label {
    font-size: 0.9rem;
    color: #ccc;
    margin-top: 0.5rem;
  }

  .book-summary {
    background: rgba(30, 30, 30, 0.8);
    padding: 2rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .book-summary h3 {
    margin-bottom: 1rem;
    color: #1e90ff;
  }

  .book-tags {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .tag {
    background: rgba(30, 144, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    border: 1px solid rgba(30, 144, 255, 0.3);
  }

  .action-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .action-btn {
    padding: 1rem 2rem;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  #addToListBtn {
    background: linear-gradient(135deg, #1e90ff, #00bfff);
    color: white;
  }

  #addToListBtn:hover:not(.added) {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(30, 144, 255, 0.4);
  }

  #addToListBtn.added {
    background: rgba(50, 50, 50, 0.7);
    cursor: not-allowed;
  }

  #previewBtn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  #previewBtn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }

  .similar-authors {
    margin-bottom: 2rem;
  }

  .similar-authors h3 {
    margin-bottom: 1rem;
    color: #1e90ff;
  }

  .authors-list {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .author-tag {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .author-tag:hover {
    background: rgba(30, 144, 255, 0.3);
    transform: translateY(-2px);
  }

  .similar-books {
    margin-top: 3rem;
  }

  .similar-books h3 {
    margin-bottom: 1.5rem;
    color: #1e90ff;
  }

  .similar-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1.5rem;
  }

  .similar-book {
    cursor: pointer;
    transition: transform 0.3s ease;
  }

  .similar-book:hover {
    transform: translateY(-5px);
  }

  .similar-book img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
  }

  .similar-title {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    text-align: center;
  }

  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: rgba(30, 144, 255, 0.9);
    color: white;
    padding: 1rem 2rem;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .loading {
    display: none;
    text-align: center;
    padding: 2rem;
  }

  .spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 4px solid #1e90ff;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @media (max-width: 768px) {
    .book-details {
      flex-direction: column;
      padding: 1.5rem;
    }

    .book-cover {
      flex: none;
      text-align: center;
    }

    .book-cover img {
      width: 250px;
      height: 375px;
    }

    .book-title {
      font-size: 2rem;
    }

    .book-meta {
      gap: 1rem;
    }

    .navbar {
      padding: 1rem 1.5rem;
      flex-direction: column;
      gap: 1rem;
    }

    .nav-links {
      flex-wrap: wrap;
      justify-content: center;
    }
  }
</style>
</head>
<body>

<div class="navbar">
  <h2>Book Haven</h2>
  <div class="nav-links">
    <button onclick="window.location.href='books.html'">Back to Books</button>
    <button onclick="window.location.href='books_recommendations.html'">Recommendations</button>
    <button onclick="window.location.href='books.html'">My Reading List</button>
    <select onchange="window.location.href='books.html'">
      <option>Browse Genres</option>
    </select>
  </div>
</div>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <p style="margin-top: 1rem;">Loading book details...</p>
</div>

<div class="book-details">
  <div class="book-cover">
    <img id="bookCover" src="" alt="Book Cover" onerror="this.src='https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'">
  </div>
  
  <div class="book-info">
    <h1 class="book-title" id="bookTitle"></h1>
    <h2 class="book-author" id="bookAuthor"></h2>
    
    <div class="book-meta">
      <div class="meta-item">
        <span class="meta-value" id="bookRating"></span>
        <span class="meta-label">Rating</span>
      </div>
      <div class="meta-item">
        <span class="meta-value" id="bookPages"></span>
        <span class="meta-label">Pages</span>
      </div>
      <div class="meta-item">
        <span class="meta-value" id="bookYear"></span>
        <span class="meta-label">Year</span>
      </div>
      <div class="meta-item">
        <span class="meta-value" id="bookGenre"></span>
        <span class="meta-label">Genre</span>
      </div>
    </div>

    <div class="book-tags" id="bookTags">
      <!-- Mood tags will be populated here -->
    </div>
    
    <div class="book-summary">
      <h3>Summary</h3>
      <p id="bookSummary"></p>
    </div>
    
    <div class="action-buttons">
      <button class="action-btn" id="addToListBtn">+ Add to Reading List</button>
      <button class="action-btn" id="previewBtn">View on Open Library</button>
    </div>

    <div class="similar-authors">
      <h3>Similar Authors</h3>
      <div class="authors-list" id="similarAuthors">
        <!-- Similar authors will be populated here -->
      </div>
    </div>
    
    <div class="similar-books">
      <h3>Similar Books You Might Like</h3>
      <div class="similar-grid" id="similarBooks">
        <!-- Similar books will be populated here -->
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// Open Library API configuration
const OPEN_LIBRARY_API = {
  works: 'https://openlibrary.org/works',
  search: 'https://openlibrary.org/search.json',
  covers: 'https://covers.openlibrary.org/b'
};

let currentBook = null;

// Get book ID from URL
const params = new URLSearchParams(window.location.search);
const bookId = params.get('id');
const bookTitle = params.get('title');

// Show/hide loading spinner
function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// Fetch book details from Open Library API
async function fetchBookDetails(id) {
  showLoading(true);
  
  try {
    const response = await fetch(`${OPEN_LIBRARY_API.works}/${id}.json`);
    
    if (!response.ok) {
      throw new Error('Book not found');
    }
    
    const data = await response.json();
    
    // Fetch additional details using search API for better data
    const searchResponse = await fetch(
      `${OPEN_LIBRARY_API.search}?q=${encodeURIComponent(data.title)}&limit=1&fields=author_name,first_publish_year,subject,isbn,cover_i,number_of_pages_median,ratings_average`
    );
    
    let searchData = null;
    if (searchResponse.ok) {
      searchData = await searchResponse.json();
    }
    
    const searchDoc = searchData?.docs?.[0];
    
    // Transform Open Library data to our format
    currentBook = {
      id: data.key.replace('/works/', ''),
      title: data.title || 'Unknown Title',
      author: searchDoc?.author_name?.[0] || 'Unknown Author',
      genre: searchDoc?.subject?.slice(0, 3) || ['Fiction'],
      rating: searchDoc?.ratings_average ? searchDoc.ratings_average.toFixed(1) : (3.5 + Math.random() * 1.5).toFixed(1),
      pages: searchDoc?.number_of_pages_median || Math.floor(Math.random() * 400) + 100,
      year: searchDoc?.first_publish_year || 'Unknown',
      summary: data.description ? 
        (typeof data.description === 'string' ? data.description : data.description.value || 'No description available.') 
        : 'No description available.',
      cover: searchDoc?.cover_i ? 
        `${OPEN_LIBRARY_API.covers}/id/${searchDoc.cover_i}-L.jpg` : 
        'https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
      openLibraryUrl: `https://openlibrary.org${data.key}`,
      subjects: searchDoc?.subject || ['fiction']
    };
    
    displayBook(currentBook);
    displaySimilarAuthors(currentBook);
    await fetchSimilarBooks(currentBook);
    checkListStatus();
    showLoading(false);
    
  } catch (error) {
    console.error('Error fetching book details:', error);
    showLoading(false);
    document.body.innerHTML = `
      <div style="text-align: center; margin-top: 5rem;">
        <h1>Book not found</h1>
        <p style="margin: 1rem 0; color: #ccc;">The requested book could not be loaded.</p>
        <button onclick="window.location.href='books.html'" style="margin-top: 2rem; padding: 1rem 2rem; background: #1e90ff; color: white; border: none; border-radius: 8px; cursor: pointer;">
          Back to Books
        </button>
      </div>
    `;
  }
}

// Fetch similar books based on current book
async function fetchSimilarBooks(book) {
  const similarGrid = document.getElementById('similarBooks');
  similarGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem;">Loading similar books...</div>';
  
  try {
    // Search for books by similar subjects
    const primarySubject = book.subjects[0] || 'fiction';
    const response = await fetch(
      `${OPEN_LIBRARY_API.search}?subject=${encodeURIComponent(primarySubject)}&limit=4&fields=key,title,cover_i`
    );
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.docs && data.docs.length > 0) {
        displaySimilarBooks(data.docs.filter(doc => doc.key !== `/works/${book.id}`).slice(0, 4));
      } else {
        similarGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem;">No similar books found</div>';
      }
    }
  } catch (error) {
    console.error('Error fetching similar books:', error);
    similarGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem;">Error loading similar books</div>';
  }
}

// Display book info
function displayBook(book) {
  document.getElementById('bookCover').src = book.cover;
  document.getElementById('bookTitle').textContent = book.title;
  document.getElementById('bookAuthor').textContent = `by ${book.author}`;
  document.getElementById('bookRating').textContent = book.rating;
  document.getElementById('bookPages').textContent = book.pages;
  document.getElementById('bookYear').textContent = book.year;
  document.getElementById('bookGenre').textContent = book.genre[0] || 'General';
  
  // Clean up and display summary
  let summary = book.summary;
  if (summary.length > 500) {
    summary = summary.substring(0, 500) + '...';
  }
  // Remove HTML tags if present
  summary = summary.replace(/<[^>]*>/g, '');
  document.getElementById('bookSummary').textContent = summary;
  
  document.title = `${book.title} - Book Haven`;
  
  // Display mood tags
  const bookTags = document.getElementById('bookTags');
  bookTags.innerHTML = '';
  const moods = getMoodFromGenre(book.subjects);
  moods.forEach(mood => {
    const tag = document.createElement('div');
    tag.className = 'tag';
    tag.textContent = mood;
    bookTags.appendChild(tag);
  });
  
  // Setup preview button
  const previewBtn = document.getElementById('previewBtn');
  previewBtn.onclick = () => window.open(book.openLibraryUrl, '_blank');
}

// Display similar authors
function displaySimilarAuthors(book) {
  const similarAuthors = document.getElementById('similarAuthors');
  similarAuthors.innerHTML = '';
  
  // For Open Library, we'll show related subjects as "similar authors"
  const relatedSubjects = book.subjects.slice(0, 3);
  relatedSubjects.forEach(subject => {
    const authorTag = document.createElement('div');
    authorTag.className = 'author-tag';
    authorTag.textContent = subject;
    authorTag.addEventListener('click', () => {
      window.location.href = `books.html?search=${encodeURIComponent(`subject:"${subject}"`)}`;
    });
    similarAuthors.appendChild(authorTag);
  });
}

// Display similar books
function displaySimilarBooks(books) {
  const similarGrid = document.getElementById('similarBooks');
  similarGrid.innerHTML = '';
  
  books.forEach(book => {
    const coverUrl = book.cover_i ? 
      `${OPEN_LIBRARY_API.covers}/id/${book.cover_i}-M.jpg` : 
      'https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80';
    
    const similarBookElement = document.createElement('div');
    similarBookElement.className = 'similar-book';
    similarBookElement.innerHTML = `
      <img src="${coverUrl}" 
           alt="${book.title}" 
           onerror="this.src='https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'">
      <div class="similar-title">${book.title}</div>
    `;
    similarBookElement.addEventListener('click', () => {
      const bookId = book.key.replace('/works/', '');
      window.location.href = `book.html?id=${bookId}&title=${encodeURIComponent(book.title)}`;
    });
    similarGrid.appendChild(similarBookElement);
  });
}

// Helper function to assign moods based on genres
function getMoodFromGenre(subjects) {
  if (!subjects || subjects.length === 0) return ['thoughtful'];
  
  const genreMoodMap = {
    'fantasy': ['magical', 'adventurous'],
    'science fiction': ['futuristic', 'thoughtful'],
    'mystery': ['suspenseful', 'mysterious'],
    'romance': ['romantic', 'emotional'],
    'horror': ['thrilling', 'dark'],
    'historical': ['educational', 'thoughtful'],
    'adventure': ['exciting', 'thrilling'],
    'comedy': ['funny', 'lighthearted'],
    'drama': ['emotional', 'thoughtful'],
    'biography': ['inspiring', 'educational']
  };
  
  for (const subject of subjects) {
    const lowerSubject = subject.toLowerCase();
    for (const [genre, moods] of Object.entries(genreMoodMap)) {
      if (lowerSubject.includes(genre)) {
        return moods;
      }
    }
  }
  
  return ['thoughtful'];
}

// Check if book is already in reading list
function checkListStatus() {
  const readingList = JSON.parse(localStorage.getItem('readingList') || '[]');
  const btn = document.getElementById('addToListBtn');
  if (readingList.some(book => book.id === currentBook.id)) {
    btn.textContent = '✓ Added to Reading List';
    btn.classList.add('added');
    btn.disabled = true;
  }
}

// Add to reading list
document.getElementById('addToListBtn').addEventListener('click', () => {
  let readingList = JSON.parse(localStorage.getItem('readingList') || '[]');

  if (!readingList.some(book => book.id === currentBook.id)) {
    readingList.push({
      id: currentBook.id,
      title: currentBook.title,
      author: currentBook.author,
      cover: currentBook.cover,
      genre: currentBook.genre,
      rating: currentBook.rating
    });

    localStorage.setItem('readingList', JSON.stringify(readingList));

    const btn = document.getElementById('addToListBtn');
    btn.textContent = '✓ Added to Reading List';
    btn.classList.add('added');
    btn.disabled = true;

    showToast(`"${currentBook.title}" added to your reading list!`);
  } else {
    showToast('This book is already in your reading list!');
  }
});

// Toast notification function
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Initialize
fetchBookDetails(bookId);
</script>

</body>
</html>