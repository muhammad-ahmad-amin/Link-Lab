<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Graph-Based Book Recommendation System</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 50%, #0c0c0c 100%); color: white; min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 30px; padding: 20px; background: rgba(20,20,20,0.8); border-radius: 15px; box-shadow:0 8px 32px rgba(0,0,0,0.3); border:1px solid rgba(30,144,255,0.3);}
    h1 { font-size: 2.8rem; margin-bottom:10px; background:linear-gradient(135deg,#1e90ff,#00bfff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
    .subtitle { font-size:1.2rem; opacity:0.9; max-width:800px; margin:0 auto; color:#ccc; }
    .content { display:flex; gap:20px; flex-wrap:wrap; }
    .panel { flex:1; min-width:300px; background: rgba(30,30,30,0.8); backdrop-filter:blur(10px); border-radius:15px; padding:20px; box-shadow:0 8px 32px rgba(0,0,0,0.2); border:1px solid rgba(30,144,255,0.2);}
    .panel-title { font-size:1.5rem; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid rgba(30,144,255,0.3); color:#1e90ff;}
    #graph-container { height:500px; width:100%; background: rgba(0,0,0,0.3); border-radius:10px; overflow:hidden; position:relative; border:1px solid rgba(255,255,255,0.1);}
    .user-controls { display:flex; flex-direction:column; gap:15px; }
    select, button { padding:10px 15px; border-radius:8px; border:none; background: rgba(51,51,51,0.8); color:white; font-weight:600; cursor:pointer; transition:all 0.3s ease; border:1px solid rgba(255,255,255,0.1);}
    button { background:linear-gradient(135deg,#1e90ff,#00bfff); color:white;}
    button:hover { background:linear-gradient(135deg,#1c86ee,#00b2ee); transform:translateY(-2px); box-shadow:0 4px 8px rgba(30,144,255,0.3);}
    .recommendations { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; margin-top:20px; }
    .book-card { background: rgba(255,255,255,0.1); border-radius:10px; padding:15px; text-align:center; transition:all 0.3s ease; cursor:pointer; border:1px solid rgba(255,255,255,0.1);}
    .book-card:hover { transform:translateY(-5px) scale(1.02); background: rgba(255,255,255,0.15); box-shadow:0 5px 15px rgba(30,144,255,0.3); border-color: rgba(30,144,255,0.5);}
    .book-cover { width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:10px; }
    .book-title { font-weight:bold; margin-bottom:5px; font-size:0.9rem; }
    .book-author { color:#ccc; font-size:0.8rem; margin-bottom:5px; }
    .book-rating { color:#FFD700; font-size:0.9rem; }
    .legend { display:flex; justify-content:center; gap:20px; margin-top:15px; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:5px; font-size:0.9rem; }
    .legend-color { width:15px; height:15px; border-radius:50%; }
    .node-info { margin-top:20px; padding:15px; background: rgba(0,0,0,0.3); border-radius:10px; font-size:0.9rem; }
    .graph-controls { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .graph-btn { background:#1e90ff; padding:8px 12px; font-size:0.9rem; border-radius:8px; }
    .spinner { border:6px solid rgba(255,255,255,0.3); border-top:6px solid #1e90ff; border-radius:50%; width:50px; height:50px; margin:0 auto; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{ transform:rotate(0deg);}100%{ transform:rotate(360deg); } }
    .navbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:1rem 0; }
    .nav-links { display:flex; gap:1rem; }
    .nav-links button { background: rgba(51,51,51,0.8); padding:0.8rem 1.5rem; }
    .nav-links button:hover { background: rgba(85,85,85,0.9); }
    .graph-stats { margin-top:15px; padding:10px; background: rgba(0,0,0,0.3); border-radius:8px; font-size:0.8rem; }
</style>
</head>
<body>
<div class="container">
    <div class="navbar">
        <h2 style="background:linear-gradient(135deg,#1e90ff,#00bfff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Book Haven</h2>
        <div class="nav-links">
            <button onclick="window.location.href='books.html'">Back to Books</button>
            <button onclick="window.location.href='books.html'">My Reading List</button>
        </div>
    </div>

    <header>
        <h1>Graph-Based Book Recommendation System</h1>
        <p class="subtitle">Explore personalized book recommendations via dynamic, interactive graphs.</p>
    </header>

    <div class="content">
        <div class="panel">
            <h2 class="panel-title">Book Recommendation Graph</h2>
            <div id="graph-container"></div>
            <div class="graph-controls">
                <button class="graph-btn" id="zoom-in">Zoom In</button>
                <button class="graph-btn" id="zoom-out">Zoom Out</button>
                <button class="graph-btn" id="reset-view">Reset View</button>
                <button class="graph-btn" id="recenter">Recenter</button>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background-color:#1e90ff;"></div><span>Primary Genre</span></div>
                <div class="legend-item"><div class="legend-color" style="background-color:#00bfff;"></div><span>Secondary Genres</span></div>
                <div class="legend-item"><div class="legend-color" style="background-color:#FF9800;"></div><span>Books</span></div>
                <div class="legend-item"><div class="legend-color" style="background-color:#FFD700;"></div><span>Recommended</span></div>
            </div>
            <div class="graph-stats" id="graph-stats"><strong>Graph Stats:</strong> Loading...</div>
            <div class="node-info">
                <h3>Node Information</h3>
                <p>Click on any node to see details here.</p>
            </div>
        </div>

        <div class="panel">
            <div class="user-controls">
                <h2 class="panel-title">Your Reading Preferences</h2>
                <div class="node-info">
                    <p>Based on your reading list and preferences, we've built this recommendation graph.</p>
                    <p><strong>Detected Preferences:</strong> <span id="user-preferences">Loading...</span></p>
                </div>
            </div>
            <div id="loader" style="display:none; text-align:center; margin-top:20px;">
                <div class="spinner"></div>
                <p>Loading recommended books...</p>
            </div>

            <h2 class="panel-title">Recommended Books</h2>
            <div class="recommendations" id="recommendations-container"></div>
        </div>
    </div>
</div>

<script>
// ---- Graph logic ----
const OPEN_LIBRARY_API = { search:'https://openlibrary.org/search.json', covers:'https://covers.openlibrary.org/b' };
let nodes=[], links=[], simulation, svg, g, transform=d3.zoomIdentity, zoom=d3.zoom();

function highlightRecommendedLinks(recommendedBookIds){
    nodes.forEach(n => n.recommended = recommendedBookIds.includes(n.id.replace("book-","")));
    links.forEach(l=>{
        const sourceId = typeof l.source==="object"?l.source.id:l.source;
        const targetId = typeof l.target==="object"?l.target.id:l.target;
        l.highlight = recommendedBookIds.includes(sourceId.replace("book-","")) || recommendedBookIds.includes(targetId.replace("book-",""));
    });
    updateGraph();
}

async function loadRecommendedBooks(){
    document.getElementById('loader').style.display='block';
    const readingList = JSON.parse(localStorage.getItem('readingList')||'[]');
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    let preferredGenres = users.length>0? users[0].preferences.genres : ["fantasy","mystery"];
    
    if(readingList.length>0){
        const genreCount={};
        readingList.forEach(book=>{ if(book.genre?.length) book.genre.forEach(g=>genreCount[g]=(genreCount[g]||0)+1)});
        preferredGenres = Object.keys(genreCount).sort((a,b)=>genreCount[b]-genreCount[a]).slice(0,6); // more genres
    }
    document.getElementById('user-preferences').textContent = preferredGenres.join(', ');

    let recommendedBooks=[];
    for(const genre of preferredGenres){
        try{
            const response = await fetch(`${OPEN_LIBRARY_API.search}?subject=${encodeURIComponent(genre)}&limit=10&fields=key,title,author_name,cover_i,ratings_average`);
            if(response.ok){ const data = await response.json(); if(data.docs) recommendedBooks = recommendedBooks.concat(data.docs.slice(0,8)); }
        }catch(err){ console.error(err);}
    }
    const uniqueBooks = Array.from(new Map(recommendedBooks.map(b=>[b.key,b])).values());
    const finalBooks = uniqueBooks.slice(0,20); // more books
    displayRecommendations(finalBooks);
    document.getElementById('loader').style.display='none';
    await buildGraph(preferredGenres,finalBooks);
    const recommendedIds = finalBooks.map(b=>b.key.replace('/works/',''));
    setTimeout(()=>highlightRecommendedLinks(recommendedIds),500);
}

function initGraph(){
    const container = document.getElementById('graph-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    d3.select("#graph-container svg").remove();
    svg = d3.select("#graph-container").append("svg").attr("width",width).attr("height",height);
    g = svg.append("g");
    g.append("g").attr("class","links");
    g.append("g").attr("class","nodes");
    zoom = d3.zoom().scaleExtent([0.1,3]).on("zoom",(event)=>{transform=event.transform; g.attr("transform",transform);});
    svg.call(zoom);
}

const colorScale = d3.scaleOrdinal().domain(["primary","secondary","book"]).range(["#1e90ff","#00bfff","#FF9800"]);

async function buildGraph(preferredGenres, recommendedBooks){
    nodes=[]; links=[];
    
    // Genres
    preferredGenres.forEach((genre,index)=>{
        const angle = (index / preferredGenres.length) * Math.PI*2;
        const radius = 250;
        nodes.push({id:`genre-${genre}`, name:genre.charAt(0).toUpperCase()+genre.slice(1), type:index===0?"primary":"secondary", x:Math.cos(angle)*radius + 400, y:Math.sin(angle)*radius + 200});
    });

    // Books
    recommendedBooks.forEach((book,index)=>{
        const angle = Math.random()*Math.PI*2;
        const radius = 350 + Math.random()*50;
        nodes.push({id:`book-${book.key.replace('/works/','')}`, name:book.title, type:"book", genres:[preferredGenres[index % preferredGenres.length]], author:book.author_name?[book.author_name[0]]:'Unknown Author', x:Math.cos(angle)*radius+400, y:Math.sin(angle)*radius+200});
    });

    // Links
    nodes.forEach(bookNode=>{
        if(bookNode.type==="book"){
            bookNode.genres.forEach(genre=>{
                const genreNode = nodes.find(n=>n.id===`genre-${genre}`);
                if(genreNode) links.push({source:genreNode.id, target:bookNode.id, weight:2, type:"genre-book"});
            });
        }
    });

    // Book-Book links
    for(let i=0;i<nodes.length;i++){
        for(let j=i+1;j<nodes.length;j++){
            if(nodes[i].type==="book" && nodes[j].type==="book"){
                const shared = nodes[i].genres.filter(g=>nodes[j].genres.includes(g));
                if(shared.length>0) links.push({source:nodes[i].id, target:nodes[j].id, weight:shared.length, type:"book-book"});
            }
        }
    }

    // Genre-Genre links
    for(let i=0;i<preferredGenres.length;i++){
        for(let j=i+1;j<preferredGenres.length;j++){
            links.push({source:`genre-${preferredGenres[i]}`, target:`genre-${preferredGenres[j]}`, weight:0.5, type:"genre-genre"});
        }
    }

    updateGraphStats();
    updateGraph();
    return true;
}

function updateGraphStats(){
    const stats = document.getElementById('graph-stats');
    const bookCount = nodes.filter(n=>n.type==="book").length;
    const genreCount = nodes.filter(n=>n.type==="primary"||n.type==="secondary").length;
    stats.innerHTML=`<strong>Graph Stats:</strong> ${genreCount} genres • ${bookCount} books • ${links.length} connections`;
}

function updateGraph(){
    const container = document.getElementById('graph-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    g.selectAll(".links line").remove();
    g.selectAll(".nodes circle").remove();
    g.selectAll(".nodes text").remove();

    const link = g.select(".links").selectAll("line").data(links,d=>d.id||`${d.source}-${d.target}`).enter().append("line")
        .attr("stroke",d=>d.highlight?"#FFD700":d.type==="genre-book"?"rgba(30,144,255,0.7)":d.type==="book-book"?"rgba(255,152,0,0.5)":"rgba(255,255,255,0.3)")
        .attr("stroke-width",d=>d.highlight?3:d.weight)
        .attr("stroke-opacity",d=>d.highlight?1:0.6);

    const node = g.select(".nodes").selectAll("circle").data(nodes,d=>d.id).enter().append("circle")
        .attr("r",d=>d.recommended?12:d.type==="primary"?20:d.type==="secondary"?16:10)
        .attr("fill",d=>d.recommended?"#FFD700":colorScale(d.type))
        .attr("stroke",d=>d.recommended?"#FFA500":"#fff")
        .attr("stroke-width",d=>d.recommended?3:2)
        .call(d3.drag().on("start",dragStarted).on("drag",dragged).on("end",dragEnded))
        .on("click",(event,d)=>showNodeInfo(d))
        .on("mouseover",(event,d)=>{d3.select(event.currentTarget).transition().duration(200).attr("r",d.r*1.5)})
        .on("mouseout",(event,d)=>{d3.select(event.currentTarget).transition().duration(200).attr("r",d.recommended?12:d.type==="primary"?20:d.type==="secondary"?16:10)});

    g.select(".nodes").selectAll("text").data(nodes,d=>d.id).enter().append("text")
        .text(d=>d.type==="book"?d.name.length>12?d.name.substring(0,12)+"...":d.name:d.name)
        .attr("font-size",d=>d.type==="primary"?"11px":d.type==="secondary"?"10px":"8px")
        .attr("dx",d=>d.type==="book"?13:15).attr("dy",4)
        .attr("fill","white").attr("opacity",0.9);

    simulation = d3.forceSimulation(nodes)
        .force("link",d3.forceLink(links).id(d=>d.id).distance(d=>d.type==="genre-book"?120:d.type==="book-book"?80:150).strength(d=>d.type==="genre-book"?0.8:d.type==="book-book"?0.3:0.2))
        .force("charge",d3.forceManyBody().strength(d=>d.type==="primary"?-1000:d.type==="secondary"?-700:-400))
        .force("center",d3.forceCenter(width/2,height/2))
        .force("collision",d3.forceCollide().radius(d=>d.type==="primary"?25:d.type==="secondary"?20:15))
        .alpha(0.7).alphaDecay(0.02).velocityDecay(0.4)
        .on("tick",()=>{
            nodes.forEach(d=>{d.x=Math.max(50,Math.min(width-50,d.x)); d.y=Math.max(50,Math.min(height-50,d.y));});
            g.selectAll(".links line").attr("x1",d=>d.source.x).attr("y1",d=>d.source.y).attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
            g.selectAll(".nodes circle").attr("cx",d=>d.x).attr("cy",d=>d.y);
            g.selectAll(".nodes text").attr("x",d=>d.x+13).attr("y",d=>d.y);
        });
}

// Dragging
function dragStarted(event,d){ if(!event.active) simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y;}
function dragged(event,d){ d.fx=event.x; d.fy=event.y;}
function dragEnded(event,d){ if(!event.active) simulation.alphaTarget(0); d.fx=null; d.fy=null;}

// Node Info
function showNodeInfo(d){
    const container = document.querySelector('.node-info');
    if(d.type==="book"){
        container.innerHTML=`<h3>${d.name}</h3><p><strong>Author:</strong> ${d.author}</p><p><strong>Genres:</strong> ${d.genres.join(', ')}</p>`;
    }else{
        container.innerHTML=`<h3>${d.name}</h3><p><strong>Type:</strong> ${d.type}</p>`;
    }
}

// Recommendations Display
function displayRecommendations(books){
    const container = document.getElementById('recommendations-container');
    container.innerHTML='';
    books.forEach(book=>{
        const div = document.createElement('div'); div.className='book-card';
        const coverId = book.cover_i?`${OPEN_LIBRARY_API.covers}/id/${book.cover_i}-M.jpg`:'https://via.placeholder.com/150x200?text=No+Cover';
        div.innerHTML=`<img class="book-cover" src="${coverId}" alt="${book.title}"><div class="book-title">${book.title.length>25?book.title.substring(0,25)+'...':book.title}</div><div class="book-author">${book.author_name?book.author_name[0]:'Unknown'}</div><div class="book-rating">${book.ratings_average?`⭐ ${book.ratings_average}`:''}</div>`;
        container.appendChild(div);
    });
}

// Zoom buttons
function addZoomControls(){
    document.getElementById('zoom-in').onclick = ()=>{svg.transition().call(zoom.scaleBy,1.3)};
    document.getElementById('zoom-out').onclick = ()=>{svg.transition().call(zoom.scaleBy,0.7)};
    document.getElementById('reset-view').onclick = ()=>{svg.transition().call(zoom.transform,d3.zoomIdentity)};
    document.getElementById('recenter').onclick = ()=>{svg.transition().call(zoom.transform,d3.zoomIdentity); simulation.force('center',d3.forceCenter(400,200)).alpha(1).restart();}
}

// Initialize
initGraph();
loadRecommendedBooks();
addZoomControls();
</script>
</body>
</html>
