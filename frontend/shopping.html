<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ShopHub - Recommendation System</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  body { background: linear-gradient(135deg, #fef3f5 0%, #e8f5e9 25%, #e3f2fd 50%, #f3e5f5 75%, #fff3e0 100%); color: #2d3748; min-height: 100vh; position: relative; overflow-x: hidden; }
  body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 20% 80%, rgba(255, 182, 193, 0.15) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(176, 224, 230, 0.15) 0%, transparent 50%); animation: pulseBackground 8s ease-in-out infinite; pointer-events: none; }
  @keyframes pulseBackground { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }
  .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1.2rem 3rem; background: linear-gradient(135deg, #ffd6e8 0%, #c8e6ff 50%, #ffd6e8 100%); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid rgba(255, 182, 193, 0.3); box-shadow: 0 5px 30px rgba(0, 0, 0, 0.1); }
  .navbar h2 { margin: 0; font-size: 2.2rem; background: linear-gradient(135deg, #ff85a1, #ffa3c7, #85d8ff, #a3d9ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: 2px; cursor: pointer; }
  .nav-links { display: flex; align-items: center; gap: 1.5rem; }
  .nav-links button, .nav-links select, #searchInput { background: rgba(255, 255, 255, 0.8); color: #4a5568; border: 2px solid rgba(255, 182, 193, 0.3); padding: 0.8rem 1.5rem; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: all 0.3s; backdrop-filter: blur(10px); }
  .nav-links button:hover, .nav-links select:hover, #searchInput:focus { background: rgba(255, 255, 255, 0.95); transform: translateY(-2px); border-color: rgba(255, 182, 193, 0.6); box-shadow: 0 8px 25px rgba(255, 182, 193, 0.3); }
  #cartBtn, #recommendationsBtn, #wishlistBtn { background: linear-gradient(135deg, #ffa3c7 0%, #85d8ff 50%, #b4e7ce 100%); color: white; font-weight: 700; border: none; box-shadow: 0 8px 25px rgba(255, 182, 193, 0.4); }
  #cartBtn:hover, #recommendationsBtn:hover, #wishlistBtn:hover { transform: translateY(-3px) scale(1.05); }
  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 2rem; padding: 3rem; max-width: 1600px; margin: 2rem auto; position: relative; z-index: 1; }
  .product-card { cursor: pointer; position: relative; overflow: hidden; border-radius: 16px; transition: all 0.4s; background: rgba(255, 255, 255, 0.9); border: 2px solid rgba(255, 182, 193, 0.3); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
  .product-card:hover { transform: translateY(-15px) scale(1.05); box-shadow: 0 25px 50px rgba(255, 182, 193, 0.3); }
  .product-card img { width: 100%; height: 250px; display: block; object-fit: cover; transition: transform 0.4s ease; background: #f7fafc; }
  .product-info { padding: 1rem; position: relative; z-index: 2; }
  .product-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
  .product-price { color: #ff85a1; font-weight: 700; font-size: 1.2rem; }
  
  /* Buttons */
  .add-to-cart, .add-to-wishlist, .remove-item { background: linear-gradient(135deg, #ffd6e8, #c8e6ff); color: #4a5568; border: 2px solid rgba(255, 182, 193, 0.3); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 0.5rem; transition: 0.3s;}
  .add-to-cart:hover { background: linear-gradient(135deg, #ffa3c7, #85d8ff); color: white; transform: translateY(-2px); }
  .add-to-wishlist:hover { background: linear-gradient(135deg, #ffa3c7, #85d8ff); color: white; transform: translateY(-2px); }
  
  /* Remove Button Specific Style */
  .remove-item { background: linear-gradient(135deg, #ffcccb, #ffb6c1); color: #e53e3e; border-color: rgba(229, 62, 62, 0.3); }
  .remove-item:hover { background: linear-gradient(135deg, #ff9999, #ff85a1); color: white; transform: translateY(-2px); }

  .rating-badge { position: absolute; top: 12px; right: 12px; background: linear-gradient(135deg, #ffd89b, #19547b); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; z-index: 2; }
  .loading { display: flex; justify-content: center; align-items: center; height: 300px; font-size: 1.5rem; color: #ff85a1; grid-column: 1/-1; }
  .spinner { width: 40px; height: 40px; border: 4px solid rgba(255, 182, 193, 0.3); border-radius: 50%; border-top-color: #ffa3c7; animation: spin 1s linear infinite; margin-right: 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="navbar">
  <h2 onclick="window.location.reload()">ShopHub</h2>
  <div class="nav-links">
    <button id="recommendationsBtn">üéØ AI Graph</button>
    <button id="wishlistBtn">üíù Wishlist</button>
    <button id="cartBtn">üõí Cart (<span id="cartCount">0</span>)</button>
    <select id="categorySelect">
      <option value="">All Categories</option>
    </select>
    <input type="text" id="searchInput" placeholder="Search products..."/>
  </div>
</div>

<div class="products-grid" id="productsGrid">
  <div class="loading"><div class="spinner"></div>Loading products...</div>
</div>

<script>
const API_URL = 'http://localhost:8080/api'; 

let allProducts = [];
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');

function saveToStorage() {
  localStorage.setItem('cart', JSON.stringify(cart));
  localStorage.setItem('wishlist', JSON.stringify(wishlist));
  updateCartCount();
}

function updateCartCount() {
  document.getElementById('cartCount').textContent = cart.length;
}

// 1. Init Categories
async function initCategories() {
  const categorySelect = document.getElementById('categorySelect');
  try {
    const res = await fetch(`${API_URL}/categories`);
    const data = await res.json();
    data.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      categorySelect.appendChild(option);
    });
  } catch (error) {
    console.error('Backend offline?', error);
  }
}

// 2. Load Products
async function loadProducts(category = 'all', search = '') {
  const productsGrid = document.getElementById('productsGrid');
  productsGrid.innerHTML = '<div class="loading"><div class="spinner"></div>Fetching from Python...</div>';
  
  try {
    let url = `${API_URL}/products?`;
    if(category !== 'all' && category) url += `category=${category}&`;
    if(search) url += `search=${search}`;
    
    const res = await fetch(url);
    const data = await res.json();
    
    allProducts = data.products || [];
    displayProducts(allProducts);
  } catch (error) {
    productsGrid.innerHTML = '<div class="loading">Error: Make sure app.py is running.</div>';
  }
}

// Display Standard Product Grid
function displayProducts(productsToShow) {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';
  
  if (!productsToShow || productsToShow.length === 0) {
    grid.innerHTML = '<div class="loading">No products found.</div>';
    return;
  }
  
  productsToShow.forEach(product => {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    // FIX: Check both thumbnail and image properties
    const imgSrc = product.thumbnail || product.image || 'https://via.placeholder.com/300';
    
    card.innerHTML = `
      <img src="${imgSrc}" alt="${product.title}" onerror="this.src='https://via.placeholder.com/300'">
      <div class="rating-badge">‚≠ê ${product.rating || '4.0'}</div>
      <div class="product-info">
        <div class="product-title">${product.title}</div>
        <div class="product-price">$${product.price}</div>
        <button class="add-to-cart" data-id="${product.id}">Add to Cart</button>
        <button class="add-to-wishlist" data-id="${product.id}">üíù Wishlist</button>
      </div>
    `;
    
    card.addEventListener('click', (e) => {
      if (!e.target.classList.contains('add-to-cart') && !e.target.classList.contains('add-to-wishlist')) {
        window.location.href = `product.html?id=${product.id}`;
      }
    });
    
    grid.appendChild(card);
  });
  
  // Attach listeners
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = parseInt(btn.getAttribute('data-id'));
      addToCart(id, btn);
    });
  });

  document.querySelectorAll('.add-to-wishlist').forEach(btn => {
      btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = parseInt(btn.getAttribute('data-id'));
          addToWishlist(id, btn);
      })
  });
}

function addToCart(id, btn) {
  const product = allProducts.find(p => p.id === id) || wishlist.find(p => p.id === id);
  if(product) {
      if(!cart.find(i => i.id === id)) {
          cart.push({...product, quantity: 1});
          saveToStorage();
          if(btn) { btn.textContent = '‚úì Added'; setTimeout(()=> btn.textContent='Add to Cart', 1000); }
      }
  }
}

function addToWishlist(id, btn) {
    const product = allProducts.find(p => p.id === id);
    if(product && !wishlist.find(i => i.id === id)) {
        wishlist.push(product);
        saveToStorage();
        if(btn) { btn.textContent = '‚úì Wishlisted'; setTimeout(()=> btn.textContent='üíù Wishlist', 1000); }
    }
}

// *** UPDATED WISHLIST FUNCTION ***
function showWishlist() {
    const grid = document.getElementById('productsGrid');
    
    if(wishlist.length === 0) { 
        grid.innerHTML = '<div class="loading">Your wishlist is empty.</div>'; 
        return; 
    }
    
    grid.innerHTML = '<h2 style="grid-column:1/-1; text-align:center; margin:2rem; color:#ff85a1">üíù Your Wishlist</h2>';
    
    wishlist.forEach(item => {
        const div = document.createElement('div');
        div.className = 'product-card';
        
        // FIX: Ensure image loads even if data is old
        const imgSrc = item.thumbnail || item.image || 'https://via.placeholder.com/300';
        
        div.innerHTML = `
            <img src="${imgSrc}" alt="${item.title}" onerror="this.src='https://via.placeholder.com/300'">
            <div class="product-info">
                <div class="product-title">${item.title}</div>
                <div class="product-price">$${item.price}</div>
                <button class="add-to-cart" data-id="${item.id}" style="margin-bottom: 5px;">Add to Cart</button>
                <button class="remove-item" onclick="removeFromWishlist(${item.id})">Remove</button>
            </div>
        `;
        
        // Add click event for details
        div.addEventListener('click', (e) => {
            if (!e.target.classList.contains('add-to-cart') && !e.target.classList.contains('remove-item')) {
                window.location.href = `product.html?id=${item.id}`;
            }
        });

        grid.appendChild(div);
    });

    // Re-attach add to cart listeners for wishlist items
    document.querySelectorAll('.add-to-cart').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = parseInt(btn.getAttribute('data-id'));
            addToCart(id, btn);
        });
    });
}

function removeFromWishlist(id) {
    // Filter out the item with the matching ID
    wishlist = wishlist.filter(p => p.id !== id);
    saveToStorage();
    // Refresh the view
    showWishlist();
}

function showCart() {
    const grid = document.getElementById('productsGrid');
    if(cart.length === 0) { grid.innerHTML = '<div class="loading">Cart is empty.</div>'; return; }
    
    grid.innerHTML = '<h2 style="grid-column:1/-1; text-align:center; margin:2rem; color:#ff85a1">üõí Your Cart</h2>';
    
    cart.forEach(item => {
        const div = document.createElement('div');
        div.className = 'product-card';
        const imgSrc = item.thumbnail || item.image || 'https://via.placeholder.com/300';

        div.innerHTML = `
            <img src="${imgSrc}" onerror="this.src='https://via.placeholder.com/300'">
            <div class="product-info">
                <div class="product-title">${item.title}</div>
                <div class="product-price">$${item.price} x ${item.quantity}</div>
                <button class="remove-item" onclick="removeFromCart(${item.id})">Remove</button>
            </div>
        `;
        grid.appendChild(div);
    });
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const totalDiv = document.createElement('div');
    totalDiv.style.gridColumn = "1/-1";
    totalDiv.style.textAlign = "center";
    totalDiv.innerHTML = `<h3>Total: $${total.toFixed(2)}</h3><button onclick="window.location.reload()" style="padding:1rem; margin-top:1rem; cursor:pointer; border-radius:12px; border:1px solid #ddd;">Back to Shop</button>`;
    grid.appendChild(totalDiv);
}

function removeFromCart(id) {
    cart = cart.filter(c => c.id !== id);
    saveToStorage();
    showCart();
}

// Events
document.getElementById('cartBtn').addEventListener('click', showCart);
document.getElementById('wishlistBtn').addEventListener('click', showWishlist);
document.getElementById('recommendationsBtn').addEventListener('click', () => window.location.href = 'shopping_recommendations.html');
document.getElementById('categorySelect').addEventListener('change', (e) => loadProducts(e.target.value));
document.getElementById('searchInput').addEventListener('input', (e) => loadProducts('', e.target.value));

// Startup
initCategories();
loadProducts();
updateCartCount();
</script>
</body>
</html>