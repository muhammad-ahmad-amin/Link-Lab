<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Link Lab - Recommendation System</title>
<style>
  /* Global Reset & Font */
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

  /* Dark Theme Body */
  body { 
    background: linear-gradient(135deg, #1a0a2e 0%, #2d1b4e 50%, #1a0a2e 100%); 
    color: #e9d5ff; 
    min-height: 100vh; 
    position: relative; 
    overflow-x: hidden; 
  }

  /* Adapted Background Animation (Dark Pulse) */
  body::before { 
    content: ''; 
    position: absolute; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    background: radial-gradient(circle at 20% 80%, rgba(168, 85, 247, 0.15) 0%, transparent 50%), 
                radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.15) 0%, transparent 50%); 
    animation: pulseBackground 8s ease-in-out infinite; 
    pointer-events: none; 
  }
  @keyframes pulseBackground { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }

  /* Navbar */
  .navbar { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 1.2rem 3rem; 
    background: rgba(26, 10, 46, 0.95); 
    backdrop-filter: blur(20px); 
    position: sticky; 
    top: 0; 
    z-index: 1000; 
    border-bottom: 1px solid rgba(138, 43, 226, 0.4); 
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5); 
  }

  /* Neon Logo Text */
  .navbar h2 { 
    margin: 0; 
    font-size: 2.2rem; 
    background: linear-gradient(135deg, #a855f7, #ec4899); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    font-weight: 800; 
    letter-spacing: 2px; 
    cursor: pointer; 
  }

  .nav-links { display: flex; align-items: center; gap: 1.5rem; }

  /* Inputs and Standard Buttons */
  .nav-links button, .nav-links select, #searchInput { 
    background: rgba(40, 20, 60, 0.6); 
    color: #e9d5ff; 
    border: 1px solid rgba(168, 85, 247, 0.4); 
    padding: 0.8rem 1.5rem; 
    border-radius: 12px; 
    cursor: pointer; 
    font-size: 1rem; 
    transition: all 0.3s; 
    backdrop-filter: blur(10px); 
  }

  .nav-links button:hover, .nav-links select:hover, #searchInput:focus { 
    background: rgba(60, 30, 90, 0.8); 
    transform: translateY(-2px); 
    border-color: #ec4899; 
    box-shadow: 0 0 15px rgba(168, 85, 247, 0.3); 
    color: white;
    outline: none;
  }

  /* Specific Action Buttons (Gradient Style) */
  #cartBtn, #recommendationsBtn, #wishlistBtn { 
    background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); 
    color: white; 
    font-weight: 700; 
    border: none; 
    box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); 
  }

  #cartBtn:hover, #recommendationsBtn:hover, #wishlistBtn:hover { 
    transform: translateY(-3px) scale(1.05); 
    box-shadow: 0 0 25px rgba(236, 72, 153, 0.6);
  }

  /* Grid Layout */
  .products-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
    gap: 2rem; 
    padding: 3rem; 
    max-width: 1600px; 
    margin: 2rem auto; 
    position: relative; 
    z-index: 1; 
  }

  /* Dark Product Card */
  .product-card { 
    cursor: pointer; 
    position: relative; 
    overflow: hidden; 
    border-radius: 20px; 
    transition: all 0.4s; 
    background: rgba(40, 20, 60, 0.8); 
    backdrop-filter: blur(10px);
    border: 1px solid rgba(168, 85, 247, 0.2); 
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); 
  }

  .product-card:hover { 
    transform: translateY(-10px) scale(1.02); 
    box-shadow: 0 0 30px rgba(138, 43, 226, 0.4); 
    border-color: rgba(236, 72, 153, 0.5);
  }

  .product-card img { 
    width: 100%; 
    height: 250px; 
    display: block; 
    object-fit: cover; 
    transition: transform 0.4s ease; 
    background: #1a0a2e; /* Fallback for transparency */
  }

  .product-info { padding: 1.5rem; position: relative; z-index: 2; }

  .product-title { 
    color: #fff;
    font-weight: 600; 
    font-size: 1.1rem; 
    margin-bottom: 0.5rem; 
    height: 45px; 
    overflow: hidden; 
    display: -webkit-box; 
    -webkit-line-clamp: 2; 
    -webkit-box-orient: vertical; 
  }

  .product-price { 
    color: #a855f7; 
    font-weight: 700; 
    font-size: 1.3rem; 
    text-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
  }
  
  /* Card Buttons */
  .add-to-cart, .add-to-wishlist, .remove-item { 
    padding: 0.8rem 1rem; 
    border-radius: 12px; 
    cursor: pointer; 
    font-weight: 600; 
    width: 100%; 
    margin-top: 0.8rem; 
    transition: 0.3s;
    font-size: 0.95rem;
    border: none;
  }

  /* Primary Button (Gradient) */
  .add-to-cart { 
    background: linear-gradient(135deg, #a855f7, #ec4899); 
    color: white; 
    box-shadow: 0 4px 10px rgba(168, 85, 247, 0.3);
  }
  .add-to-cart:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
  }

  /* Secondary Button (Outline Style) */
  .add-to-wishlist { 
    background: rgba(168, 85, 247, 0.1); 
    color: #c4b5fd; 
    border: 1px solid rgba(168, 85, 247, 0.4); 
  }
  .add-to-wishlist:hover { 
    background: rgba(168, 85, 247, 0.2); 
    color: white; 
    border-color: #a855f7;
    transform: translateY(-2px); 
  }
  
  /* Remove Button (Red/Danger Gradient) */
  .remove-item { 
    background: linear-gradient(135deg, #ef4444, #b91c1c); 
    color: white; 
    box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
  }
  .remove-item:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
  }

  .rating-badge { 
    position: absolute; 
    top: 12px; 
    right: 12px; 
    background: linear-gradient(135deg, #f59e0b, #fbbf24); 
    color: #1a0a2e; 
    padding: 0.4rem 0.8rem; 
    border-radius: 20px; 
    font-size: 0.8rem; 
    font-weight: 800; 
    z-index: 2; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }

  .loading { 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 300px; 
    font-size: 1.5rem; 
    color: #a855f7; 
    grid-column: 1/-1; 
  }

  .spinner { 
    width: 40px; 
    height: 40px; 
    border: 4px solid rgba(168, 85, 247, 0.3); 
    border-radius: 50%; 
    border-top-color: #ec4899; 
    animation: spin 1s linear infinite; 
    margin-right: 1rem; 
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="navbar">
  <h2 onclick="window.location.reload()">Link Lab</h2>
  <div class="nav-links">
    <button id="recommendationsBtn">üéØ AI Graph</button>
    <button id="wishlistBtn">üíù Wishlist</button>
    <button id="cartBtn">üõí Cart (<span id="cartCount">0</span>)</button>
    <select id="categorySelect">
      <option value="">All Categories</option>
    </select>
    <input type="text" id="searchInput" placeholder="Search products..."/>
  </div>
</div>

<div class="products-grid" id="productsGrid">
  <div class="loading"><div class="spinner"></div>Loading products...</div>
</div>

<script>
const API_URL = 'http://localhost:8000/api'; 

let allProducts = [];
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');

function saveToStorage() {
  localStorage.setItem('cart', JSON.stringify(cart));
  localStorage.setItem('wishlist', JSON.stringify(wishlist));
  updateCartCount();
}

function updateCartCount() {
  document.getElementById('cartCount').textContent = cart.length;
}

// 1. Init Categories
async function initCategories() {
  const categorySelect = document.getElementById('categorySelect');
  try {
    const res = await fetch(`${API_URL}/categories`);
    const data = await res.json();
    data.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      categorySelect.appendChild(option);
    });
  } catch (error) {
    console.error('Backend offline?', error);
  }
}

// 2. Load Products
async function loadProducts(category = 'all', search = '') {
  const productsGrid = document.getElementById('productsGrid');
  productsGrid.innerHTML = '<div class="loading"><div class="spinner"></div>Fetching from Python...</div>';
  
  try {
    let url = `${API_URL}/products?`;
    if(category !== 'all' && category) url += `category=${category}&`;
    if(search) url += `search=${search}`;
    
    const res = await fetch(url);
    const data = await res.json();
    
    allProducts = data.products || [];
    displayProducts(allProducts);
  } catch (error) {
    productsGrid.innerHTML = '<div class="loading">Error: Make sure app.py is running.</div>';
  }
}

// Display Standard Product Grid
function displayProducts(productsToShow) {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';
  
  if (!productsToShow || productsToShow.length === 0) {
    grid.innerHTML = '<div class="loading">No products found.</div>';
    return;
  }
  
  productsToShow.forEach(product => {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    // FIX: Check both thumbnail and image properties
    const imgSrc = product.thumbnail || product.image || 'https://via.placeholder.com/300';
    
    card.innerHTML = `
      <img src="${imgSrc}" alt="${product.title}" onerror="this.src='https://via.placeholder.com/300'">
      <div class="rating-badge">‚≠ê ${product.rating || '4.0'}</div>
      <div class="product-info">
        <div class="product-title">${product.title}</div>
        <div class="product-price">$${product.price}</div>
        <button class="add-to-cart" data-id="${product.id}">Add to Cart</button>
        <button class="add-to-wishlist" data-id="${product.id}">üíù Wishlist</button>
      </div>
    `;
    
    card.addEventListener('click', (e) => {
      if (!e.target.classList.contains('add-to-cart') && !e.target.classList.contains('add-to-wishlist')) {
        window.location.href = `product.html?id=${product.id}`;
      }
    });
    
    grid.appendChild(card);
  });
  
  // Attach listeners
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = parseInt(btn.getAttribute('data-id'));
      addToCart(id, btn);
    });
  });

  document.querySelectorAll('.add-to-wishlist').forEach(btn => {
      btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = parseInt(btn.getAttribute('data-id'));
          addToWishlist(id, btn);
      })
  });
}

function addToCart(id, btn) {
  const product = allProducts.find(p => p.id === id) || wishlist.find(p => p.id === id);
  if(product) {
      if(!cart.find(i => i.id === id)) {
          cart.push({...product, quantity: 1});
          saveToStorage();
          if(btn) { btn.textContent = '‚úì Added'; setTimeout(()=> btn.textContent='Add to Cart', 1000); }
      }
  }
}

function addToWishlist(id, btn) {
    const product = allProducts.find(p => p.id === id);
    if(product && !wishlist.find(i => i.id === id)) {
        wishlist.push(product);
        saveToStorage();
        if(btn) { btn.textContent = '‚úì Wishlisted'; setTimeout(()=> btn.textContent='üíù Wishlist', 1000); }
    }
}

// *** UPDATED WISHLIST FUNCTION ***
function showWishlist() {
    const grid = document.getElementById('productsGrid');
    
    if(wishlist.length === 0) { 
        grid.innerHTML = '<div class="loading">Your wishlist is empty.</div>'; 
        return; 
    }
    
    grid.innerHTML = '<h2 style="grid-column:1/-1; text-align:center; margin:2rem; color:#ff85a1">üíù Your Wishlist</h2>';
    
    wishlist.forEach(item => {
        const div = document.createElement('div');
        div.className = 'product-card';
        
        // FIX: Ensure image loads even if data is old
        const imgSrc = item.thumbnail || item.image || 'https://via.placeholder.com/300';
        
        div.innerHTML = `
            <img src="${imgSrc}" alt="${item.title}" onerror="this.src='https://via.placeholder.com/300'">
            <div class="product-info">
                <div class="product-title">${item.title}</div>
                <div class="product-price">$${item.price}</div>
                <button class="add-to-cart" data-id="${item.id}" style="margin-bottom: 5px;">Add to Cart</button>
                <button class="remove-item" onclick="removeFromWishlist(${item.id})">Remove</button>
            </div>
        `;
        
        // Add click event for details
        div.addEventListener('click', (e) => {
            if (!e.target.classList.contains('add-to-cart') && !e.target.classList.contains('remove-item')) {
                window.location.href = `product.html?id=${item.id}`;
            }
        });

        grid.appendChild(div);
    });

    // Re-attach add to cart listeners for wishlist items
    document.querySelectorAll('.add-to-cart').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = parseInt(btn.getAttribute('data-id'));
            addToCart(id, btn);
        });
    });
}

function removeFromWishlist(id) {
    // Filter out the item with the matching ID
    wishlist = wishlist.filter(p => p.id !== id);
    saveToStorage();
    // Refresh the view
    showWishlist();
}

function showCart() {
    const grid = document.getElementById('productsGrid');
    if(cart.length === 0) { grid.innerHTML = '<div class="loading">Cart is empty.</div>'; return; }
    
    grid.innerHTML = '<h2 style="grid-column:1/-1; text-align:center; margin:2rem; color:#ff85a1">üõí Your Cart</h2>';
    
    cart.forEach(item => {
        const div = document.createElement('div');
        div.className = 'product-card';
        const imgSrc = item.thumbnail || item.image || 'https://via.placeholder.com/300';

        div.innerHTML = `
            <img src="${imgSrc}" onerror="this.src='https://via.placeholder.com/300'">
            <div class="product-info">
                <div class="product-title">${item.title}</div>
                <div class="product-price">$${item.price} x ${item.quantity}</div>
                <button class="remove-item" onclick="removeFromCart(${item.id})">Remove</button>
            </div>
        `;
        grid.appendChild(div);
    });
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const totalDiv = document.createElement('div');
    totalDiv.style.gridColumn = "1/-1";
    totalDiv.style.textAlign = "center";
    totalDiv.innerHTML = `<h3>Total: $${total.toFixed(2)}</h3><button onclick="window.location.reload()" style="padding:1rem; margin-top:1rem; cursor:pointer; border-radius:12px; border:1px solid #ddd;">Back to Shop</button>`;
    grid.appendChild(totalDiv);
}

function removeFromCart(id) {
    cart = cart.filter(c => c.id !== id);
    saveToStorage();
    showCart();
}

// Events
document.getElementById('cartBtn').addEventListener('click', showCart);
document.getElementById('wishlistBtn').addEventListener('click', showWishlist);
document.getElementById('recommendationsBtn').addEventListener('click', () => window.location.href = 'shopping_recommendations.html');
document.getElementById('categorySelect').addEventListener('change', (e) => loadProducts(e.target.value));
document.getElementById('searchInput').addEventListener('input', (e) => loadProducts('', e.target.value));

// Startup
initCategories();
loadProducts();
updateCartCount();
</script>
</body>
</html>